# cronManager

# 简介

cronManager是一个纯PHP实现的定时任务管理工具,api简单清晰,采用的是多进程模型,进程通信采用的是消息队列,任务监控也提供了简单的命令,方便易用

# 特性

* 多进程模型

* 支持守护进程

* 平滑重启

* 提供各种命令监控任务运行状态

* 支持一个任务由多个进程同时,以不同的标识运行一个任务

## 环境要求

1. liunx
2. pcntl扩展开启
3. php 5.4以上
4. composer


* 手动安装记得要先 `composer update`一下哦！

## 使用介绍

核心方法 `CronManager::taskInterval($name, $command, $callable, $ticks = [])` 

参数1 $name 定时任务名称

参数2 $command 

传入string则表示用key@value的形式表示
1. `s@n` 表示每n秒运行一次 
2. `i@n` 表示每n分钟运行一次 
3. `h@n` 表示每n小时运行一次
4. `at@nn:nn` 表示指定每天的nn:nn执行 例如每天凌晨 at@00:00

传入array则表示依次运行数组里的每一个指定日期,要求每一个元素都可以被`strtotime`函数解析,否则运行不了
如: `['2017-09-09 08:00','2017-09-09 08:00']`

参数3 $callable 回调函数,也就是定时任务业务逻辑

参数4 $ticks 用于单任务多进程时标识

## 快速入门示例

``` php

//test.php

require __DIR__ . '/../vendor/autoload.php';

$manager = new SuperCronManager\CronManager();

// bash的alias脚本别名,要生效需要用 source .bash_xxxxx 生效!
$manager->alias = 'cron-manager';

// 设置worker数
$manager->workerNum = 5;

// 设置输出重定向,守护进程模式才生效
$manager->output = './test.log';

$manager->taskInterval('每秒钟运行一次', 's@1', function(){
	echo "Hello crontabManager\n";
});
$manager->taskInterval('每分钟运行一次', 'i@1', function(){
	echo "Hello crontabManager\n";
});
$manager->taskInterval('每小时运行一次', 'h@1', function(){
	echo "Hello crontabManager\n";
});
$manager->taskInterval('每天凌晨运行一次', 'at@00:00', function(){
	echo "Hello crontabManager\n";
});
$manager->taskInterval('任务分片', 's@1', function($str){
	echo "$str\n";
},[1,2]);

$manager->taskInterval('分片测试', ['2017-12-20 23:28','2017-12-20 23:30'], function($index){
	echo "ticks $index\n";
});

$manager->run();


```

## 命令使用示例

* 检测扩展是否启动，缺少扩展将无法使用。 建议第一次运行先使用此命令查看扩展情况

> php test.php check

```
+----------+--------+------+------+
| name     | status | desc | help |
+----------+--------+------+------+
| php>=5.4 | [OK]   |      |      |
| pcntl    | [OK]   |      |      |
| posix    | [OK]   |      |      |
| sysvmsg  | [OK]   |      |      |
| sysvsem  | [OK]   |      |      |
| sysvshm  | [OK]   |      |      |
+----------+--------+------+------+
```

* 启动

>  php test.php

```
+------------+--------------------------+
| pid        | 28264                    |
+------------+--------------------------+
| output     | ./test.log               |
+------------+--------------------------+
| alias      | cron-manager             |
+------------+--------------------------+
| bashFile   | /root/.bash_cron-manager |
+------------+--------------------------+
| task_num   | 7                        |
+------------+--------------------------+
| worker_num | 5                        |
+------------+--------------------------+
| start_time | 2018-01-02 22:47:51      |
+------------+--------------------------+

```

* 以守护进程方式启动（`无任何提示表示成功`）

>  php test.php -d

* 查看任务状态

>  php test.php status

```
+------------+--------------------------+
| pid        | 28264                    |
+------------+--------------------------+
| output     | ./test.log               |
+------------+--------------------------+
| alias      | cron-manager             |
+------------+--------------------------+
| bashFile   | /root/.bash_cron-manager |
+------------+--------------------------+
| task_num   | 7                        |
+------------+--------------------------+
| worker_num | 5                        |
+------------+--------------------------+
| start_time | 2018-01-02 22:47:51      |
+------------+--------------------------+
+----+------------------+------------------+----------+-------+---------------------+---------------------+
| id | name             | tag              | status   | count | last_time           | next_time           |
+----+------------------+------------------+----------+-------+---------------------+---------------------+
| 0  | 每秒钟运行一次   | s@1              | 正常     | 71    | 2018-01-02 22:49:02 | 2018-01-02 22:49:03 |
| 1  | 每分钟运行一次   | i@1              | 正常     | 1     | 2018-01-02 22:48:51 | 2018-01-02 22:49:51 |
| 2  | 每小时运行一次   | h@1              | 正常     | 0     | -                   | 2018-01-02 23:47:51 |
| 3  | 每天凌晨运行一次 | at@00:00         | 正常     | 0     | -                   | 2018-01-03 00:00:00 |
| 4  | 任务分片         | s@1              | 正常     | 71    | 2018-01-02 22:49:02 | 2018-01-02 22:49:03 |
| 5  | 任务分片         | s@1              | 正常     | 71    | 2018-01-02 22:49:02 | 2018-01-02 22:49:03 |
| 6  | 分片测试         | 2017-12-20 23:30 | 过期关闭 | 0     | -                   | -                   |
+----+------------------+------------------+----------+-------+---------------------+---------------------+
```

* 查看worker状态

>  php test.php worker

```
+------------+--------------------------+
| pid        | 28264                    |
+------------+--------------------------+
| output     | ./test.log               |
+------------+--------------------------+
| alias      | cron-manager             |
+------------+--------------------------+
| bashFile   | /root/.bash_cron-manager |
+------------+--------------------------+
| task_num   | 7                        |
+------------+--------------------------+
| worker_num | 5                        |
+------------+--------------------------+
| start_time | 2018-01-02 22:47:51      |
+------------+--------------------------+
+-------+------------+---------+---------------------+
| pid   | exec_count | memory  | start_time          |
+-------+------------+---------+---------------------+
| 28265 | 69         | 0.6(mb) | 2018-01-02 22:47:51 |
| 28266 | 67         | 0.6(mb) | 2018-01-02 22:47:51 |
| 28267 | 73         | 0.6(mb) | 2018-01-02 22:47:51 |
| 28268 | 51         | 0.6(mb) | 2018-01-02 22:47:51 |
| 28269 | 51         | 0.6(mb) | 2018-01-02 22:47:51 |
+-------+------------+---------+---------------------+
```
* 查看服务日志(这个有点LOW，就是直接读日志文件输出)

>  php test.php log

```
2017-12-09 14:03:44 PID:19690 [debug] master启动
```
